---
title : Apache Kafka Producer -2-
tags :
- acks
- Producer
- Kafka
---

*이 포스트는 [Kafka Definitive Guide](https://github.com/Avkash/mldl/blob/master/pages/docs/books/confluent-kafka-definitive-guide-complete.pdf)를 바탕으로 작성하였습니다.*

## Configuring Producers

### acks

acks 매개 변수는 전송된 레코드의 수를 제어합니다. 이 매개변수는 메세지가 유실될 가능성에 큰 영항을 주며, 다음 3가지 값을 설정할 수 있습니다. 옵션에대해서 간략하게 설명하면 아래 표를 확인하시면 됩니다.

|Option|Message Loss|Speed|Description|
|:--:|:--:|:--:|:--:|
|0|High|High|프로듀서는 자신이 보낸 메시지에 대해 카프카로부터 확인을 기다리지 않습니다.|
|1|Medium|Medium|프로듀서는 자신이 보낸 메시지에 대해 카프카의 leader가 메시지를 받았는지 기다립니다.|
|all(-1)|Low|Low|프로듀서는 자신이 보낸 메시지에 대해 카프카의 leader와 follower까지 받았는지 기다립니다.|

**acks = 0**

![image](https://user-images.githubusercontent.com/44635266/70320577-719cfa80-1868-11ea-8bc1-7377a7e08d07.png)

프로듀서는 브로커의 응답을 기다리지 않습니다. 브로커가 메세지를 수신하지 못했을 경우 프로듀서는 알지 못하므로, 메세지가 유실이 됩니다.

네트워크가 지원하는 성능만큼 빨리 메세지를 전송할 수 있어서 매우 높은 처리량이 필요할 때 사용됩니다.

**acks = 1**

![image](https://user-images.githubusercontent.com/44635266/70320581-7366be00-1868-11ea-97b7-413f181d8ae6.png)

리더 리플리카가 메세지를 받는 순간 프로듀서는 브로커로부터 성공적으로 수신했다는 응답을 받는다. 만약 리더에서 메세지를 쓸 수 없다면, 프로듀서는 에러 응답을 받으며, 데이터 유실을 막기 위해 메세지를 다시 전송할 수 있다.

이때는 동기식이나 비동기식 중 어떤 방법으로 메세지를 전송했는가에 따라 처리량이 달라진다.

**acks = all(-1)**

![image](https://user-images.githubusercontent.com/44635266/70320583-7497eb00-1868-11ea-89c5-c0e36a140b74.png)

동기화된 모든 리플리카가 메세지를 받으면 프로듀서가 브로커의 성공 응답을 받는다. 가장 안전한 형태다. 왜냐하면, 하나 이상의 브로커가 해당 메세지를 가지고 있으므로, 리더 리플리카에 문제가 생겨도 메세지가 유실되지 않기 때문이다.

### buffer.memory

브로커들에게 전송될 메세지의 버퍼로 사용할 메모리의 양이다.

### compression.type

기본적으로 메세지는 압축되지 않은 상태로 전송되지만, 이 매개변수를 설정하면 압축되어 전송한다. 예시 값중 하나로 snappy, gzip, lz4 다.

### retries

프로듀서가 서버로부터 받는 에러는 일시적일 수 있다. 이 경우 retires 매개변수의 값을 설정하면, 메세지 전송을 포기하고 에러로 처리하기 전에 프로듀서가 메세지를 재전송하는 횟수를 제어할 수 있다.

디폴트로는 프로듀서는 각 재전송간에 100ms 동안 대기한다.

### batch.size

같은 파티션에 쓰는 다수의 레코드가 전송될 때는 프로듀서가 그것들을 배치로 모은다. 이 매개변수는 각 배치에 사용될 메모리양을 제어한다. 그리고 해당 배치가 가득차면 그것의 모든 메세지가 전송된다.

하지만, 배치가 가득 찰 때까지 가디리는것은 아니다. 

### linger.ms

현재의 배치를 전송하기 전까지 기다리는 시간(ms)을 나타는대. 그리고 현재의 배치가 가득 찼거나, linger.bs에 설정된 제한 시간이 되면 프로듀서가 메세지 배치를 전송한다.

### client.id

어떤 클라이언트에서 전송된 메세지인지 식별하기 위해 브로커가 사용한다. 주로 로그 메세지와 메트릭 데이터의 전송에 사용된다.

### max.inflight.requests.per.connection

서버의 응답을 받지 않고 프로듀서가 전송하는 메세지의 개수를 제어한다. 이 매개변수의 값을 크게 설정하면 메모리 사용량은 즈가하지만 처리량은 좋아진다.

하지만, 너무 큰 값으로 설정하면 메세지의 배치 처리가 비효율적으로 되므로 오히려 처리량이 감소할 수 있다.

### timeout.ms, request.timeout.ms, metadata.fetch.timeout.ms

데이터를 전송할 때(request.timeout.ms) , 메타데이터를 요청할 때(metadata.fetch.timeout.ms) 프로듀서가 서버의 응답을 기다리는 제한 시간을 가진다.

timeout.ms는 동기화된 레플리카들이 메세지들을 인지하는 동안 브로커가 대기하는 시간을 제어한다.

### max.block.ms

send() 메서드를 호출할 때 프로듀서의 전송 버퍼가 가득 차거나 사용할 수 없을 때 프로듀서가 max.block.ms의 시간동안 일시 중단된다. 그 다음에 max.block.ms의 시간이 되면 시간 경과 예외가 발생한다.

### max.request.size

이 매개변수는 프로듀서가 전송하는 쓰기 요청의 크기를 제어한다. 전송될 수 있는 가장 큰 메세지의 크기와 프로듀서가 하나의 요청으로 전송할 수 있는 메세지의 최대 개수 모두를 이 매개변수로 제한한다.

### receive.buffer.butes / send.buffer.bytes

데이터를 읽고 쓸 때 소켓이 사용하는 TCP 송수신 버퍼의 크기를 나타낸다. 만약 **-1**로 설정하면 운영체제의 디폴트값으로 사용된다.