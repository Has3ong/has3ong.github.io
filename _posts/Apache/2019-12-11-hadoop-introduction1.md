---
title : Hadoop Distributed FileSystem
tags :
- datanode
- namenode
- Hadoop
---

*이 포스트는 [Hadoop The Definitive Guide, 4th Edition](https://github.com/Farheen2302/hadoop-project/blob/master/hadoop_reading/Hadoop%20The%20Definitive%20Guide%2C%204th%20Edition.pdf)를 바탕으로 작성하였습니다.*

## Hadoop Distributed FileSystem

데이터가 단일 물리 머신의 저장 용량을 초과하게 되면 전체 데이터셋을 분리된 여러 머신에 저장할 필요가 있다. 네트워크로 연결된 여러 머신의 스토리지를 관리하는 파일 시스템을 분산파일시스템이라고 한다.

분산 파일 시스템은 네트워크 기반이라 일반적인 디스크 파일 시스템보다 훨씬 복잡하다. 특정 노드에 장애가 발생하여도 자료가 유실되지 않는 파일 시스템이 필요하다. 하둡은 HDFS라는 분산 파일시스템을 제공하여 이러한 문제를 해결한다. 

### Architecture

**이점**

* 매우 큰 파일
* 스트리밍 방식의 데이터 접근
* 범용 하드웨어

**단점**

* 빠른 데잍어 응답 시간
* 수 많은 작은 파일
* 다중 라이터와 파일의임의 수정

## HDFS Concept

### Block

물리적인 디스크는 블록 크기라는 개념이 있습니다. 디스크 블록의 크기는 기본적으로 512Byte 입니다. HDFS 블록은 기본적으로 128MB와 같이 굉장히 큰 단위입니다. HDFS 의 파일은 블록 크기보다 작은 데이터일 경우 전체 블록 크기에 해당하는 하위 디스크를 모두 점유하지 않습니다.

예를 들어 128MB 블록크기의 1MB 크기의 파일을 저장하면 1MB 의 디스크만 사용합니다.

> HDFS 블록이 큰 이유는 탐색 비용을 최소화 하기 위해서다.

분산 파일시스템에 블록 추상화의 개념을 도입하면서 얻게되는 몇가지 이점이있다.

1. 파일 하나의 크기가 단일 디스크의 용량보다 더 커질수 있다.
2. 파일 단위보다는 블록 단위로 추상화하여 스토리지의 서브 시스템을 단순하게 만들 수 있다.

## NameNode / DataNode

HDFS 클러스터는 마스터-워커 패턴으로 동작하는 두 종류의 노드 네임노드와 여러개의 데이터노드로 구성되어 있습니다.

### NameNode

1. 파일시스템의 네임 스페이스 관리
2. 파일시스템 트리와 트리에 포함된 모든 파일과 디렉터리에 대한 메타데이터 유지 관리

메타데이터는 네임스페이스 이미지와 에디트 로그라는 두 종류의 파일로 로컬 디스크에 영속적으로 저장된다. 하지만, 블록의 위치 정보는 시스템이 시작할때 모든 데이터 노드로부터 받아 재구성하기 때문에 영속적으로 저장하지 않는다.

### DataNode

1. HDFS 의 실질적인 일꾼
2. 클라이언트나 네임노드의 요청이 있을때 블록을 저장 및 탐색

네임 노드가 없으면 파일 시스템은 동작하지 않습니다. 따라서 네임노드의 장애복구 기능을 위해 Hadoop은 두 가지 메커니즘을 제공합니다.

1. 파일 시스템의 메타 데이터를 지속적인 상태로 보존하기 위해 파일로 백업
2. 보조 네임노드를 운영

### Secondary NameNode

보조 네임노드는 주 네임노드와 다르게 동작한다. 보조 네임노드의 주 역할은 에디트 로그가 너무 커지지 않도록 주기적으로 네임 스페이스 이미지를 에디트 로그와 병합하여 새로운 네임스페이스 이미지를 만드는것이다.

또한, 보조 네임노드는 주 네이몬드에 장애가 발생할 것을 대비해서 네임스페이스 이미지의 복제본을 보관하는 역할도 맡는다.

## Block Cache

데이터노드는 디스크에 저장된 블록을 읽는다. 하지만 빈번하게 접근하는 블록 파일은 **블록 캐시** 라는 데이터 노드의 메모리에 명시적으로 캐싱한다.

기본적으로 블록은 하나의 데이터노드 메모리에만 캐싱되지만 파일 단위로 설정이 가능하다.

사용자나 어플리케이션은 Cache Pool 에 Cache Directive 를 추가하여 특정 파일을 캐싱하도록 명령할 수 있다.

## HDFS Federation

HDFS 페더레이션을 이용하면 각 네임노드는 네임스페이스의 메타데이터를 구성하는 **네임스페이스 볼륨(namespace volume)** 과 네임스페이스에 포함된 파일의 전체 블록을 보고나하는 **블록 풀(block pool)** 을 관리한다.

네임스페이스 볼륨은 서로 독립되어 있으며, 따라서 네임노드는 서로 통신할 필요가 없고, 특정 네임노드에 장애가 발생해도 네임노드가 관리하는 네임스페이스의 가용성에 영향을 주지 않는다. 하지만 블록 풀의 저장소눈 분리되어 있지 않다.

## Failover Controller / Fencing

네임노드를 활성화시키는 전환 작업은 **장애복구 컨트롤러(Failover Controller)** 라는 객체로 관리된다. 기본 구현방법은 하나의 네임노드만 활성 상태에 있는것을 보장하기 위해 Zookeeper 를 이용한다.

장애복구는 정기적인 유지관리를 위해 관리자가 수동으로 초기화할 수 있다. 이를 **우아한 장애복구** 라고도 합니다. 두 개의 네임노드가 서로 역할을 바꾸게 하는 방법으로 전환 순서를 제어할 수 있다.

그러나 장애가 발생한 네임노드가 현재 실행되지 않고 있다는것을 확신하기 어렵습니다. 예를 들어 네트워크가 느려지거나 단절되어 장애복구를 위한 작업이 시작된 상황에서도 기존의 활성 네임노드는 여전히 실행되고 있고 자신이 활성 네임노드라 생각할 수 있습니다. 고가용성을 구현하기 위해서는 기존의 활성 네임노드가 시스템을 손상시키거나 망가뜨리지 않도록 엄청난 노력을 기울이는데 이를 위해 **펜싱(fencing)** 이라는 메소드를 제공한다.
맨위로


