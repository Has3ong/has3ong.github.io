---
title : Ethereum Transaction -7-
tags :
- Multiple-Signature
- Recording Blockchain
- Transaction Propagation
- Transmission
- Separating Signing
- Ethereum
---

*이 포스트는 [Mastering Ethereum](https://github.com/ethereumbook/ethereumbook)를 바탕으로 작성하였습니다.*

## Separating Signing and Transmission

트랜잭션이 서명되면 트랜잭션은 이더리움 네트워크로 전송할 준비가 됩니다. 트랜잭션 생성, 서명, 브로드캐스트의 3 단계는 일반적으로 단일 작업에 의해 처리됩니다. 하지만, 2 단계로 나누어 트랜잭션을 생성하고 서명합니다.

서명된 트랜잭션이 있으면 `web3.eth.sendSignedTransaction` 을 사용하여 트랜잭션을 16 진수로 인코딩하고 서명해서 이더리움 네트워크에서 전송할 수 있습니다.

트랜잭션의 서명과 전송을 분리하는 보편적인 이유는 보안입니다. 트랜잭션에 서명하는 컴퓨터에는 잠금 해제된 개이니가 메모리에 로드되어 있어야 합니다. 전송을 수행하는 컴퓨터는 인터넷에 연결되어 있어야 하며, 이더리움 클라이언트를 실행해야 합니다. 이 2 기능이 하나의 컴퓨터에 있으면 온라인 시스템에 개인키가 있게 되며, 이는 위험한 상황입니다.

따라서 서명 및 전송 기능을 분리하여 각기 다른 시스템(offline, online) 에서 수행하는 것을 **오프라인 서명(offline signing)** 이라 하며, 이는 일반적인 보안 방법 입니다.

아래 `Example 1` 은 이더리움 트랜잭션의 오프라인 서명 프로세스를 보여줍니다.

> Example 1 - Offline signing of Ethereum transactions

![image](https://user-images.githubusercontent.com/44635266/71893186-3c006f80-318e-11ea-9b28-7a2264a8ae04.png)

1. 현재의 nonce 및 사용 가능한 자금을 검색할 수 있는 계정에서 서명되지 않은 트랜잭션을 온라인 컴퓨터에 만듭니다.
2. 서명되지 않은 트랜잭션을 QR 코드 또는 USB 를 통해 트랜잭션 서명을 위한 air-gapped 오프라인 장치로 전송한다.
3. 이더리움 블록체인에 브로드캐스트하기 위해, 서명된 트랜잭션을 QR 코드 또는 USB 를 통해 온라인 장치로 전송한다.

필요한 보안 수준에 따라 격리되고 방화벽이 있는 서브넷 에서 에어 갭 시스템으로 알려진 오프라인 시스템에 이르기까지 온라인 컴퓨터와 분리 정도를 다르게 할 수 있습니다.

에어 갭 시스템에서는 네트워크 연결이 없습니다. 트랜잭션에 서명하려면 데이터 저장 매체 또는 웹캠과 QR 코드를 사용하여 에어 갭 컴퓨터와 주고받는 트랜잭션을 생성합니다. 물론 이것은 서명하고자 하는 모든 트랜잭션을 수동으로 전송해야 하며 스케일링할 수 없습니다.

에어 갭 시스템을 많이 사용할 수 없지만 약간의 격리로도 많은 보안 이점을 얻을 수 있습니다. 예를들어 메세지 대기열 프로토콜만 허용하는 방화벽이 있는 격리된 서브넷은 온라인 시스템에 서명하는 것보다 공격할 부분을 줄어들게 하고 훨씬 높은 보안을 제공할 수 있습니다.

### Transaction Propagation

이더리움 네트워크는 **플러드 라우팅(flood routing)** 프로토콜을 사용합니다. 이더리움 클라이언트는 **메시(mesh)** 네트워크를 형성하는 **피어투피어(P2P)** 네트워크에서 **노드(node)** 역할을 합니다. 어떠한 네트워크 노드도 특별하지 않습니다. 노드란 네트워크에 연결되어 참여하는 모든 이더리움 클라이언트 입니다.

트랜잭션 전파는 서명된 트랜잭션을 생성한 이더리움 노드에서 시작합니다. 트랜잭션은 검증된 후에 트랜잭션을 생성한 직접 연결한 다른 모든 이더리움 노드로 전송됩니다.

평균적으로 각 이더리움 노드는 **이웃(neighbor)** 이라고 불리는 13개의 다른 노드에 대한 연결을 유지합니다. 각 이웃 노드는 트랜잭션을 수신하자마자 즉시 유효성을 검사합니다. 그리고 노드가 검증에 동의하면 사본을 저장하고 모든 이웃에게 전파합니다. 결과적으로 트랜잭션은 네트워크의 모든 노드가 트랜잭션 사본을 가질 때까지 원래 노드에서 *물결치며 퍼진다(flooding)* 노드는 전달하는 메세지를 필터링 할 수 있지만, 기본 규칙은 전달 받은 모든 유효한 트랜잭션 메세지를 전파하는 것입니다.

각 노드의 관점에서 보면 트랜잭션의 출처를 식별할 수 없습니다. 노드로 전송한 이웃 노드는 트랜잭션의 생성자이거나 인접 노드 중 하나로부터 트랜잭션을 수신했을 수 있습니다. 트랜잭션의 출처를 추적하거나 전파를 방해하기 위해 공격자는 모든 노드 중 상당 부분을 제어해야 합니다. 이것은 P2P 네트워크의 보안 및 개인정보 보호 설계의 일부이며, 특히 블록체인 네트워크에 적용됩니다.

### Recording on the Blockchain

이더리움의 모든 노드는 동등한 피어지만, 일부는 채굴을 하며 GPU 가 장착된 컴퓨터인 **채굴 팜(mining farm)** 에 트랜잭션 및 블록을 제공합니다. 채굴 컴퓨터는 트랜잭션을 후보 블록에 추가하고 후보 블록을 유효하게 만드는 **작업증명(PoW)** 를 찾으려고 시도합니다.

유효한 트랜잭션이 결국 트랜잭션 블록에 포함되어 이더리움 블록체인에 기록됩니다. 트랜잭션이 블록으로 채워지면 계정의 잔액을 수정하거나 내부 상태를 변경하는 컨트랙트를 호출하여 트랜잭션은 이더리움 싱글톤 상태를 수정합니다. 이러한 변경사항은 트랜잭션 **영수증(receipt)** 형식으로 트랜잭션과 기록됩니다.

생성에서 EOA 에 의한 서명, 전파, 그리고 채굴까지 완료된 트랜잭션은 싱글톤의 상태를 변경하고 블록체인에서 지울 수 없는 기록을 남깁니다.

### Multiple-Signature (Multisig) Transactions

여러명의 유저 당사자가 트랜잭션에 서명할 때만 자금을 사용할 수 있는 **비트코인 다중 서명(multiple signature, multisig)** 계정을 만들 수 있다. 이더리움의 기본 EOA 값 트랜잭션에는 다중 서명 조항이 없습니다. 그러나 이더와 토큰을 전송하는 어떤 조건들도 처리할 수 있는 스마트 컨트랙트를 사용하여 임의의 서명 룰을 적용할 수 있습니다.

스마트 컨트랙트로 다중 서명 트랜잭션을 구현하는 기능은 이더리움의 유연성을 입증합니다. 그러나 이러한 유연성으로 인해 다중 서명 체계의 보안을 약화시키는 버그가 발생할 수 있으므로 양날의 검입니다. 실제로 간단한 *M - of - N* 다중 서명 구성을 스마트 컨트랙트를 이용하지 않고 EVM 에서 직접 다중 서명 명령을 처리하게 하자는 제안이 많습니다. 이는 핵심 합의 규칙의 일부이며, 강력하고 안전한 것으로 입증된 비트코인의 다중 서명 시스템과 동일합니다.