<!doctype html>

<html class="no-js" lang="en">

<head>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	Try

	Index Theme by https://jekyllthemes.io
	Premium + free Jekyll themes for your blog or website.

	- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->


	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<!-- Page Info -->
	<link rel="shortcut icon" href="/images/icon.png">
	<title>Kafka Reliable Data Delivery -1- – Try</title>
	<meta name="description" content="">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Kafka Reliable Data Delivery -1- – Try">
	<meta name="twitter:description" content="">
	<meta name="twitter:image:src" content="">

	<!-- Facebook OpenGraph -->
	<meta property="og:title" content="Kafka Reliable Data Delivery -1- – Try" />
	<meta property="og:description" content="" />
	<meta property="og:image" content="" />

	
	<!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,500" rel="stylesheet">
	

	<!-- Styles -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/css/style.css">
	
	<!-- Icons -->
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/solid.js" integrity="sha384-GXi56ipjsBwAe6v5X4xSrVNXGOmpdJYZEEh/0/GqJ3JTHsfDsF8v0YQvZCJYAiGu" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/brands.js" integrity="sha384-0inRy4HkP0hJ038ZyfQ4vLl+F4POKbqnaUB6ewmU4dWP0ki8Q27A0VFiVRIpscvL" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/fontawesome.js" integrity="sha384-NY6PHjYLP2f+gL3uaVfqUZImmw71ArL9+Roi9o+I4+RBqArA2CfW1sJ1wkABFfPe" crossorigin="anonymous"></script>

	
	<!-- Custom Styles -->
	<style></style>
	

	
	<!-- Analytics Code -->
	
	

	
	<!-- Extra Header JS Code -->
	
	

	
	
</head>


<body class="loading ajax-loading" data-site-url="http://localhost:4000" data-page-url="/blog/kafka-reliabledatadelibery1">


	<header class="header">

	<div class="header__content">

		
		<a href="/" class="header__title">
			Try
		</a>
		

		<h1 class="header__tagline">The man who moves a mountain begins by carrying away small stones. - Confucius</h1>

		<div class="menu">
			<div class="menu__toggle js-menu-toggle">
				<div class="menu__toggle__icon"><span></span></div>
			</div>
			<div class="menu__wrap">
				<ul class="menu__list">
					
					<li class="menu__list__item">
						<a href="/about" class="menu__list__item__link">About</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/apache" class="menu__list__item__link">Apache</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/blockchain" class="menu__list__item__link">BlockChain</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/computerscience" class="menu__list__item__link">Computer Science</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/database" class="menu__list__item__link">DataBase</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/devops" class="menu__list__item__link">DevOps</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/imageprocessing" class="menu__list__item__link">Image Processing</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/machinelearning" class="menu__list__item__link">Machine Learning</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/programming" class="menu__list__item__link">Programming</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/softwaremaestro" class="menu__list__item__link">SW Maestro</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/web" class="menu__list__item__link">Web</a>
					</li>
					
				</ul>
			</div>
		</div>

		<div class="projects-menu">
			<ul class="menu__list">
				
			</ul>
		</div>

		<div class="header__lower">

			<ul class="socials">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://github.com/has3ong" target="_blank" class="socials__item__link" title="Github">
			<i class="fab fa-github" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://www.linkedin.com/in/%ED%95%98%EC%84%B1-%EA%B9%80-145aa21a0/" target="_blank" class="socials__item__link" title="Linkedin">
			<i class="fab fa-linkedin" aria-hidden="true"></i>
		</a>
	</li>
	
	
</ul>

			<div class="footer__copyright">
				<span>© 2020 Try</span>
				Has3ong
			</div>

		</div>

	</div>

</header>


	<div class="loader"><svg width="120" height="30" viewBox="0 0 120 30" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="60" cy="15" r="9" fill-opacity="0.3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="0.5" to="0.5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle></svg></div>

	<div class="page-loader"></div>

	
	<div class="page">

		<div class="page__content" data-page-title="Kafka Reliable Data Delivery -1- – Try">

			<section class="intro">

	<div class="wrap">

		<h1>Kafka Reliable Data Delivery -1-</h1>
		<p>17 December 2019</p>

	</div>

</section>

<section class="single">

	<div class="wrap">

		<p><em>이 포스트는 <a href="https://github.com/Avkash/mldl/blob/master/pages/docs/books/confluent-kafka-definitive-guide-complete.pdf">Kafka Definitive Guide</a>를 바탕으로 작성하였습니다.</em></p>

<h2 id="reliability-guarantees">Reliability Guarantees</h2>

<p>신뢰성을 얘기할 때 우리는 <strong>보장(guarantee)</strong> 을 거론합니다.</p>

<p>가장 많이 알려진 신뢰성 보장은 ACID 입니다. RDB 가 보편적으로 지원하는 표준화된 신뢰성 보장입니다. ACID 는 <strong>원자성(Atomicity) ,일관성(Consistency), 고립성(Isolation), 지속성(Durability)</strong> 을 의미합니다. 따라서 어떤 데이터베이스가 ACID 를 준수한다면 그것은 트랜잭션 처리와 관련된 약속된 행동을 보장한다는 의미입니다.</p>

<p>이런 보장이 있기 때문에 어플리케이션에서 RDB 를 믿고 사용할 수 있습니다. 그렇다면 Apache Kafka 에서는 무엇을 보장하는지 알아보겠습니다.</p>

<ol>
  <li>Kafka 에서는 파티션의 메세지 순서를 보장합니다.</li>
  <li>각 파티션의 모든 ISR 에 메세지를 썻다면 해당 메세지는 커밋된 것으로 간주한다.</li>
  <li>최소 하나의 레플리카가 살아있다면 커밋된 메세지는 유실되지 않는다.</li>
  <li>컨슈머는 커밋된 메세지만 읽을 수 있다.</li>
</ol>

<p>신뢰성 있는 시스템을 만들기 위해서는 트레이드오프가 수반됩니다. 따라서 Kafka 는 관리자와 개발자들이 필요한 신뢰성의 정도를 조절할 수 있게 개발되었습니다.</p>

<p>신뢰도가 높고 지속적으로 메세지를 저장하는 것의 중요도와 가용성, 높은 처리량, 낮은 지연 시간 하드웨어 비용의 중요도 중 어느것에 더 큰 비중을 둘 것인지 알 수 있습니다.</p>

<h2 id="replication">Replication</h2>

<p>파티션마다 다수의 레플리카를 가질 수 있는 Kafka 의 복제 매커니즘은 신뢰성 보장의 핵심 입니다. 장애 발생시 Kafka 가 메세지의 지속성을 제공하는 방법이 다수의 레플리카에 메세지를 쓰는 것이기 때문이다.</p>

<p>Kafka 의 각 토픽은 데이터를 저장하는 기본 요소인 파티션으로 분할되며, 각 파티션은 하나의 디스크에 저장이 됩니다. Kafka 는 파티션 내부의 메세지 순서를 보장하며, 파티션은 온라인 또는 오프라인이 될 수 있다. 각 파티션은 다수의 레플리카를 가질 수 있으며, 레플리카 중 하나는 리더로 지명되며, 모든 메세지는 리더 레플리카에 쓰거나 읽습니다. 이외의 다른 레플리카들은 팔로워라하며, 리더와 동기화되면서 떄에 맞춰 최근의 모든 메세지를 복제합니다. 만일 리더를 사용할 수 없게 되면 동기화된 레플리카 중 하나가 리더가 됩니다.</p>

<p>레플리카가 파티션의 리더이거나 다음과 같은 팔로워일때 그 레플리카는 동기화되는것으로 간주됩니다.</p>

<ol>
  <li>Zookeeper 와 세션이 열결되어 있음(Zookeeper 에게 하트비트를 전송했음)</li>
  <li>최근 10초 내에 리더로부터 메세지를 읽었음</li>
</ol>

<p>만일 위 두 사항을 만족하지 않으면 동기화 되지 않는 것으로 간주하여 Zookeeper 와 다시 연결되어 리더에 저장된 가장 최근 메세지드띾지 복제하면 동기화 상태가 됩니다.</p>

<p>동기화에 약간 뒤쳐진 동기화 레플리카는 프로듀서와 컨슈머의 처리 속도를 저하할 수 있습니다. 메세지가 커밋되기 전에 모든 동기화 레플리카의 메세지 수신을 기다리기 때문입니다. 하지만, 레플리카가 동기화되지 않은 상태면 메세지 수신을 기다리지 않습니다. 이 경우 레플리카는 여전히 동기화가 뒤쳐지겟지만 프로듀서와 컨슈머의 처리 성능에는 영향을 주지 않습니다.</p>

<h3 id="replication-factor">Replication Factor</h3>

<p>토픽 수준에서 <strong>복제 펙터(replication factor)</strong> 를 구성하는 매개변수는 <em>replication.factor</em> 입니다. 브로커 수준에서는 자동 생성되는 토픽에 대해 default.replication.factor 매개변수를 설정할 수 있습니다.</p>

<p>복제 팩터가 N 이면 N-1 개의 브로커가 중단되더라도 여전히 토픽의 데이터를 신뢰성 있게 읽거나 쓸 수 있습니다. 따라서 복제 팩터가 클수록 가용성과 신뢰성은 높아지고 장애에 따른 데이터 유실은 적어진다. 바념ㄴ에, 복제 팩터가 N 일 경우 최소한 N 개의 브로커가 필요하고 N 개의 복사본을 저장해야 하므로 N 배의 디스크 공간이 필요하다. 그러므로 가용성을 높이는 대신 하드웨어가 많이 소요된다.</p>

<p>보통 가용성이 중요한 토픽은 복제 팩터를 3으로 설정할 것은 권한다.</p>

<p>레플리카들의 위치도 매우 중요 합니다. 기본적으로 Kafka 는 파티션의 각 레플리카들을 별개의 브로커에 둡니다. 하지만, 파티션의 모든 레플리카들이 같은 랙에 있는 브로커들에 속해있는 경우 랙이 오작동하면 복제 팩터와는 무관하게 파티션의 가용성을 상실하게 됩니다. 따라서 랙 수준의 장애를 방지하기 위해 다수의 랙에 브로커드들을 위치시킨 후 브로커 구성 매개변수인 broker.rack 을 사용해 각 브로커의 랙 이름을 설정할 것은 권한다.</p>

<h3 id="unclean-leader-election">Unclean Leader Election</h3>

<p>이 구성은 브로커 수준에서만 사용할 수 있다. 매개변수 이름은 <code class="highlighter-rouge">unclean.leader.election.enable</code> 이며 기본값은 true 다.</p>

<p>파티션의 리더를 더 이상 사용할 수 없다면 동기화 레플리카 중 하나가 새로운 리더가 선출된다. 이 경우 데이터가 유실되지 않는다는 것이 보장되므로 이것을 클린 리더 선출이라 한다.</p>

<p>하지만 동기화된 레플리카들이 아예 없다면 어떻게 해야할까.</p>

<p>두 가지 시나리오로 알아보겠습니다.</p>

<blockquote>
  <p>Scenario 1</p>
</blockquote>

<p>파티션에는 3개의 레플리카가 있는데 2개의 팔로어를 사용할 수 없게 되었다. 프로듀서가 리더에 계속 쓰는 동안 모든 메세지는 수신이 확인되고 커밋된다. 사용할 수 있는 동기화된 레플리카가 리더뿐이기 떄문이다.</p>

<p>다음에는 리더를 사용할 수 없게 된다고 가정해보겠습니다. 비동기화 팔로어 중 하나가 먼저 시작된다면, 결국 해당 파티션의 사용할 수 있지만 유일한 레플리카로 비동기화 팔로어만 남게된다.</p>

<blockquote>
  <p>Scenario 2</p>
</blockquote>

<p>파티션에 3개의 레플리카가 있다. 네트워크에 문제가 생겨 2개의 팔로어가 복제가 뒤쳐졌다. 그리고 여전이 사용할 수는 있지만 동기화되지 않게 되었다.</p>

<p>이 경우 리더는 유일한 동기화 레플리카가 되어 메세지를 계속 받는다. 그 다음에 리더를 사용할 수 없게 된다면, 두 개의 사용 가능한 레플리카들은 이후로도 계속 동기화될 수 없다.</p>

<p>두 개의 시나리오에서 다음과 같은 판단을 내립니다.</p>

<ul>
  <li>비동기화 레플리카를 새로운 리더가 될 수 없게 한다면, 해당 파티션은 이전 리더가 온라인이 될 때까지 오프라인 상태로 남게 된다. 상황에 따라서는 수 시간이 걸릴 수 있다.</li>
  <li>비동기화 레플리카를 새로운 리거다 될수 있게 한다면, 해당 레플리카가 동기화 되지 않는 동안 이전 리더에 썻던 메세지들을 잃게 되고 컨슈머 간에 일관성도 결여될 수 있다.</li>
</ul>

<p>비동기화 레플리카가 리더가 될 수 있게 한다면 데이터 유실과 일관성 결여의 위험을 감수해야 하며, 그렇지 않고 리더가 될 수 없게 한다면, 가용성이 떨어지는 것에 직면하게 된다. 원래 리더를 사용할 수 있게 되어 해당 파티션이 다시 온라인 상태로 될 때까지 기다려야한다.</p>

<p><code class="highlighter-rouge">unclean.leader.election.enable</code> 를 false 로 설정하면 리더가 온라인이 되기를 기다린다는 의미이므로 가용성이 떨어 질 수 있다. 일반적으로 데이터 품질과 일관성이 중요한 시스템에서는 언클린 리더 선출을 하지 못하게 한다.</p>

<h3 id="minimum-in-sync-replicas">Minimum In-Sync Replicas</h3>

<p>토픽과 브로커 구성에 관련된 구성 매개변수로 <code class="highlighter-rouge">min.insync.replicas</code> 가 있다.</p>

<p>커밋된 데이터를 하나 이상의 레플리카에 확실하게 쓰고자 한다면, 동기화 레플리카의 최소 개수를 더 큰 값으로 설정해야 합니다. 하나의 토픽이 3개의 레플리카를 가질 떄 <code class="highlighter-rouge">min.insync.replicas</code> 매개변수를 2로 설정하면 3개의 레플리카 중에서 최소 2개가 동기화될 때 토픽의 파티션에 쓸 수 있습니다.</p>

<p>이 경우 3개의 모든 레플리카가 동기화된다면 모든 것이 정상으로 처리됩니다. 만약 3개 중 2개를 사용할 수 없게 되면 브로커들이 더 이상 쓰기 요청을 받지 않게 되며, 데이터를 쓰려고 하는 프로듀서는 NotEnoughReplicasException 에러를 받게 됩니다.</p>

<p>그러나 컨슈머는 기존 데이터를 계속 읽을 수 있습니다. 이 경우 하나의 동기화 레플리카가 읽기 전용이 되는 셈이며, 그럼으로써 바람직하지 않은 데이터를 읽고 쓰는것을 방지하고 언클린 리더가 선출되지 않게 합니다.</p>

<p>그리고 읽기 전용 상황을 원래대로 복구하기 위해서는 사용 불가능한 2 개의 레플리카 중 하나를 다시 사용할 수 잇게 한 후 밀렸던 메세지를 처리하고 동기화되도록 해야 한다.</p>


	</div>



</section>
			
				<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://has3ong-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			

		</div>

	</div>

	<footer class="footer">

	<ul class="socials">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://github.com/has3ong" target="_blank" class="socials__item__link" title="Github">
			<i class="fab fa-github" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://www.linkedin.com/in/%ED%95%98%EC%84%B1-%EA%B9%80-145aa21a0/" target="_blank" class="socials__item__link" title="Linkedin">
			<i class="fab fa-linkedin" aria-hidden="true"></i>
		</a>
	</li>
	
	
</ul>

	<div class="footer__copyright">
		<span>© 2020 Try</span>
		Has3ong
	</div>

</footer>


	<!-- Javascript Assets -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="/js/index-min.js"></script>

	
	<!-- Extra Footer JS Code -->
	
	


</body>

</html>