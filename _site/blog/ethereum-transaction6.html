<!doctype html>

<html class="no-js" lang="en">

<head>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	Try

	Index Theme by https://jekyllthemes.io
	Premium + free Jekyll themes for your blog or website.

	- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->


	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<!-- Page Info -->
	<link rel="shortcut icon" href="/images/icon.png">
	<title>Ethereum Transaction -6- – Try</title>
	<meta name="description" content="">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Ethereum Transaction -6- – Try">
	<meta name="twitter:description" content="">
	<meta name="twitter:image:src" content="">

	<!-- Facebook OpenGraph -->
	<meta property="og:title" content="Ethereum Transaction -6- – Try" />
	<meta property="og:description" content="" />
	<meta property="og:image" content="" />

	
	<!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,500" rel="stylesheet">
	

	<!-- Styles -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/css/style.css">
	
	<!-- Icons -->
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/solid.js" integrity="sha384-GXi56ipjsBwAe6v5X4xSrVNXGOmpdJYZEEh/0/GqJ3JTHsfDsF8v0YQvZCJYAiGu" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/brands.js" integrity="sha384-0inRy4HkP0hJ038ZyfQ4vLl+F4POKbqnaUB6ewmU4dWP0ki8Q27A0VFiVRIpscvL" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/fontawesome.js" integrity="sha384-NY6PHjYLP2f+gL3uaVfqUZImmw71ArL9+Roi9o+I4+RBqArA2CfW1sJ1wkABFfPe" crossorigin="anonymous"></script>

	
	<!-- Custom Styles -->
	<style></style>
	

	
	<!-- Analytics Code -->
	
	

	
	<!-- Extra Header JS Code -->
	
	

	
  	<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$'] ],
    processEscapes: true,
  }
});
MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
	
	
</head>


<body class="loading ajax-loading" data-site-url="http://localhost:4000" data-page-url="/blog/ethereum-transaction6">


	<header class="header">

	<div class="header__content">

		
		<a href="/" class="header__title">
			Try
		</a>
		

		<h1 class="header__tagline">The man who moves a mountain begins by carrying away small stones. - Confucius</h1>

		<div class="menu">
			<div class="menu__toggle js-menu-toggle">
				<div class="menu__toggle__icon"><span></span></div>
			</div>
			<div class="menu__wrap">
				<ul class="menu__list">
					
					<li class="menu__list__item">
						<a href="/about" class="menu__list__item__link">About</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/apache" class="menu__list__item__link">Apache</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/blockchain" class="menu__list__item__link">BlockChain</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/computerscience" class="menu__list__item__link">Computer Science</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/database" class="menu__list__item__link">DataBase</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/devops" class="menu__list__item__link">DevOps</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/imageprocessing" class="menu__list__item__link">Image Processing</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/machinelearning" class="menu__list__item__link">Machine Learning</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/programming" class="menu__list__item__link">Programming</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/softwaremaestro" class="menu__list__item__link">SW Maestro</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/web" class="menu__list__item__link">Web</a>
					</li>
					
				</ul>
			</div>
		</div>

		<div class="projects-menu">
			<ul class="menu__list">
				
			</ul>
		</div>

		<div class="header__lower">

			<ul class="socials">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://github.com/has3ong" target="_blank" class="socials__item__link" title="Github">
			<i class="fab fa-github" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://www.linkedin.com/in/%ED%95%98%EC%84%B1-%EA%B9%80-145aa21a0/" target="_blank" class="socials__item__link" title="Linkedin">
			<i class="fab fa-linkedin" aria-hidden="true"></i>
		</a>
	</li>
	
	
</ul>

			<div class="footer__copyright">
				<span>© 2020 Try</span>
				Has3ong
			</div>

		</div>

	</div>

</header>


	<div class="loader"><svg width="120" height="30" viewBox="0 0 120 30" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="60" cy="15" r="9" fill-opacity="0.3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="0.5" to="0.5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle></svg></div>

	<div class="page-loader"></div>

	
	<div class="page">

		<div class="page__content" data-page-title="Ethereum Transaction -6- – Try">

			<section class="intro">

	<div class="wrap">

		<h1>Ethereum Transaction -6-</h1>
		<p>07 January 2020</p>

	</div>

</section>

<section class="single">

	<div class="wrap">

		<p><em>이 포스트는 <a href="https://github.com/ethereumbook/ethereumbook">Mastering Ethereum</a>를 바탕으로 작성하였습니다.</em></p>

<h2 id="transaction-signing-in-practice">Transaction Signing in Practice</h2>

<p>유효한 트랜잭션을 생성하기 위해선 ECDSA 를 사용하여 메세지에 디지털 서명을 해야합니다. 트랜잭션에 서명하는 말을 곧 RLP 시리얼라이즈된 트랜잭션 데이터의 Keccak-256 해시에 서명하라는 뜻이다. 서명은 트랜잭션 자체가 아니라 트랜잭션 데이터의 해시에 적용됩니다.</p>

<p>발신자는 이더리움에서 트랜잭션을 발생하기 위해 반드시 다음 과정을 거쳐야 합니다.</p>

<ol>
  <li><strong>nonce</strong>, <strong>gasPrice</strong>, <strong>gasLimit</strong>, <strong>to</strong>, <strong>value</strong>, <strong>data</strong>, <strong>chainID</strong>, <strong>0</strong>, <strong>0</strong> 의 9개 필드를 포함하는 트랜잭션 데이터 구조를 만든다.</li>
  <li>RLP 로 인코딩된 트랜잭션 데이터 구조의 시리얼라이즈된 메세지를 생성한다.</li>
  <li>시리얼라이즈된 메세지의 Keccak-256 의 해시를 계산한다.</li>
  <li>EOA 의 개인키로 해시에 서명하여 ECDSA 서명을 계산한다.</li>
  <li>ECDSA 서명의 계산된 <strong>v</strong>, <strong>r</strong>, <strong>s</strong> 값을 트랜잭션에 추가한다.</li>
</ol>

<p>특수 서명 변수 v 는 2 가지를 나타내는데, ECDSArecover 함수가 서명을 확인하는 데 도움이 되는 복구 식별자와 체인 ID 이다. v 는 27 또는 28 중 하나로 계산되거나, 체인 ID 의 2배 에 35, 36 이 더해져 계산됩니다.</p>

<h2 id="raw-transaction-creation-and-signing">Raw Transaction Creation and Signing</h2>

<p>아래 코드는 원시 트랜잭션을 생성하고 <code class="highlighter-rouge">ethereu,js-tx</code> 라이브러리를 사용하여 서명합니다. 일반적으로 사용자를 대신해서 트랜잭션에 서명을 하는 지갑 또는 어플리케이션의 함수가 어떻게 작동하는지를 보여줍니다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Load requirements first:
//
// npm init
// npm <span class="nb">install </span>ethereumjs-tx
//
// Run with: <span class="nv">$ </span>node raw_tx_demo.js
const ethTx <span class="o">=</span> require<span class="o">(</span><span class="s1">'ethereumjs-tx'</span><span class="o">)</span><span class="p">;</span>

const txData <span class="o">=</span> <span class="o">{</span>
  nonce: <span class="s1">'0x0'</span>,
  gasPrice: <span class="s1">'0x09184e72a000'</span>,
  gasLimit: <span class="s1">'0x30000'</span>,
  to: <span class="s1">'0xb0920c523d582040f2bcb1bd7fb1c7c1ecebdb34'</span>,
  value: <span class="s1">'0x00'</span>,
  data: <span class="s1">''</span>,
  v: <span class="s2">"0x1c"</span>, // Ethereum mainnet chainID
  r: 0,
  s: 0 
<span class="o">}</span><span class="p">;</span>

tx <span class="o">=</span> new ethTx<span class="o">(</span>txData<span class="o">)</span><span class="p">;</span>
console.log<span class="o">(</span><span class="s1">'RLP-Encoded Tx: 0x'</span> + tx.serialize<span class="o">()</span>.toString<span class="o">(</span><span class="s1">'hex'</span><span class="o">))</span>

txHash <span class="o">=</span> tx.hash<span class="o">()</span><span class="p">;</span> // This step encodes into RLP and calculates the <span class="nb">hash
</span>console.log<span class="o">(</span><span class="s1">'Tx Hash: 0x'</span> + txHash.toString<span class="o">(</span><span class="s1">'hex'</span><span class="o">))</span>

// Sign transaction
const privKey <span class="o">=</span> Buffer.from<span class="o">(</span>
    <span class="s1">'91c8360c4cb4b5fac45513a7213f31d4e4a7bfcb4630e9fbf074f42a203ac0b9'</span>, <span class="s1">'hex'</span><span class="o">)</span><span class="p">;</span>
tx.sign<span class="o">(</span>privKey<span class="o">)</span><span class="p">;</span>

serializedTx <span class="o">=</span> tx.serialize<span class="o">()</span><span class="p">;</span>
rawTx <span class="o">=</span> <span class="s1">'Signed Raw Transact
</span></code></pre></div></div>

<p>예제 코드를 실행하면 다음과 같은 결과가 생성됩니다.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node raw_tx_demo.js
RLP-Encoded Tx: 0xe6808609184e72a0008303000094b0920c523d582040f2bcb1bd7fb1c7c1...
Tx Hash: 0xaa7f03f9f4e52fcf69f836a6d2bbc7706580adce0a068ff6525ba337218e6992
Signed Raw Transaction: 0xf866808609184e72a0008303000094b0920c523d582040f2bcb1...
</code></pre></div></div>

<h3 id="raw-transaction-creation-with-eip-155">Raw Transaction Creation with EIP-155</h3>

<p><em>EIP-155 Simple Replay Attack Protection</em> 표준은 서명하기 전에 트랜잭션 데이터 내부에 <strong>체인 식별자(chain identifier)</strong> 를 포함하여 재생공격 방지가 가능한 트랜잭션 인코딩을 지정한다. 이렇게 하면 하나의 블록체인에 대해 생성된 트랜잭션이 다른 블록체인에서 유효하지 않습니다. 따라서 표준의 이름 그대로 한 네트워크에서 전파된 트랜잭션은 다른 네트워크에서 재생될 수 없습니다.</p>

<p>EIP-155 는 트랜잭션 데이터 구조의 주요 6개 필드에 <strong>체인식별자, 0, 0</strong> 의 3개 필드를 추가합니다. 이 3필드는 인코딩되고 해싱되기 전에 트랜잭션 데이터에 추가됩니다.  따라서 트랜잭션의 해시가 변경되어 나중에 서명이 적용됩니다. 체인 식별자가 서명한 데이터에 포함됨으로써, 트랜잭션 서명은 체인 식별자가 수정되면 서명이 무효화되어 데이터 변경을 식별할 수 있다. 따라서 EIP-155 는 서명의 유효성이 체인 식별자에 의존하기 때문에 다른 체인에서 트랜잭션을 재생할 수 없습니다.</p>

<blockquote>
  <p>Chain identifiers</p>
</blockquote>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Chain</th>
      <th style="text-align: center">Chain ID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Ethereum mainnet</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">Morden (obsolete), Expanse</td>
      <td style="text-align: center">2</td>
    </tr>
    <tr>
      <td style="text-align: center">Ropsten</td>
      <td style="text-align: center">3</td>
    </tr>
    <tr>
      <td style="text-align: center">Rinkeby</td>
      <td style="text-align: center">4</td>
    </tr>
    <tr>
      <td style="text-align: center">Rootstock mainnet</td>
      <td style="text-align: center">30</td>
    </tr>
    <tr>
      <td style="text-align: center">Rootstock testnet</td>
      <td style="text-align: center">31</td>
    </tr>
    <tr>
      <td style="text-align: center">Kovan</td>
      <td style="text-align: center">42</td>
    </tr>
    <tr>
      <td style="text-align: center">Ethereum Classic mainnet</td>
      <td style="text-align: center">61</td>
    </tr>
    <tr>
      <td style="text-align: center">Ethereum Classic testnet</td>
      <td style="text-align: center">62</td>
    </tr>
    <tr>
      <td style="text-align: center">Geth private testnets</td>
      <td style="text-align: center">1337</td>
    </tr>
  </tbody>
</table>

<p>결과로 생성되는 트랜잭션 구조는 RLP 로 인코딩되고 해싱되고 서명됩니다. 서명 알고리즘은 v 접두어에 체인 식별자를 인코딩하기 위해 약간 수정됩니다.</p>

<h3 id="the-signature-prefix-value-v-and-public-key-recovery">The Signature Prefix Value (v) and Public Key Recovery</h3>

<p>서명자의 공개키를 복구하는 프로세스를 <strong>공개키 복구(public key recovery)</strong> 라고 합니다.</p>

<p>먼저 서명에 있는 x 좌표인 r 값에서 2개의 타원 곡선 점 $R$ 과 $R^`$ 를 계산 합니다. 타원 곡선은 x 축에 대칭이므로, 어떤 값 x 에 대해서도 곡선에 2개의 가능한 값이 있기 때문에 2개의 점이 있습니다.</p>

<p>r 에서 우리는 r 의 곱셈 역함수인 $r^{-1}$ 를 계산합니다.</p>

<p>마지막으로 메세지 해시의 m 최하위 비트인 z 를 계산합니다. 여기서 n 은 타원 곡선의 차수입니다. 그결과 가능한 공개키는 다음과 같습니다.</p>

<script type="math/tex; mode=display">K_1 = r^{-1}(sR-zG)\\
K_2 = r^{-1}(sR-zG)</script>

<ul>
  <li>$K_1$ 과 $K_2$ 는 서명자의 2 가지 가능한 공개키</li>
  <li>$r^{-1}$ 은 서명 $r$ 곱셈 역함수</li>
  <li>s 는 서명의 $s$ 값</li>
  <li>$R$ 과 $R^`$ 는 ㄷ2가지 가능한 일시적인 공개키 $Q$</li>
  <li>z 는 메세지 해시의 n 최하위 비트</li>
  <li>G 는 타원 곡선 생성자 점</li>
</ul>

<p>좀 더 효율적으로 접근하기 위해, 트랜잭션 서명에는 2개의 가능한 R 값 중 임시 공개키가 무엇인지 알려주는 접두어 값 v 가 포함됩니다. v 가 짝수이면 $R$ 이 올바른 값이고, v 가 홀수이면 $R^`$ 입니다. 이런식으로 각각 하나의 값만 계산해야 합니다.</p>


	</div>



</section>
			
				<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://has3ong-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			

		</div>

	</div>

	<footer class="footer">

	<ul class="socials">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://github.com/has3ong" target="_blank" class="socials__item__link" title="Github">
			<i class="fab fa-github" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://www.linkedin.com/in/%ED%95%98%EC%84%B1-%EA%B9%80-145aa21a0/" target="_blank" class="socials__item__link" title="Linkedin">
			<i class="fab fa-linkedin" aria-hidden="true"></i>
		</a>
	</li>
	
	
</ul>

	<div class="footer__copyright">
		<span>© 2020 Try</span>
		Has3ong
	</div>

</footer>


	<!-- Javascript Assets -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="/js/index-min.js"></script>

	
	<!-- Extra Footer JS Code -->
	
	


</body>

</html>