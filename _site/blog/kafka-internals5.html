<!doctype html>

<html class="no-js" lang="en">

<head>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	Try

	Index Theme by https://jekyllthemes.io
	Premium + free Jekyll themes for your blog or website.

	- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->


	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<!-- Page Info -->
	<link rel="shortcut icon" href="/images/icon.png">
	<title>Apache Kafka Internals -5- – Try</title>
	<meta name="description" content="">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Apache Kafka Internals -5- – Try">
	<meta name="twitter:description" content="">
	<meta name="twitter:image:src" content="">

	<!-- Facebook OpenGraph -->
	<meta property="og:title" content="Apache Kafka Internals -5- – Try" />
	<meta property="og:description" content="" />
	<meta property="og:image" content="" />

	
	<!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,500" rel="stylesheet">
	

	<!-- Styles -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/css/style.css">
	
	<!-- Icons -->
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/solid.js" integrity="sha384-GXi56ipjsBwAe6v5X4xSrVNXGOmpdJYZEEh/0/GqJ3JTHsfDsF8v0YQvZCJYAiGu" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/brands.js" integrity="sha384-0inRy4HkP0hJ038ZyfQ4vLl+F4POKbqnaUB6ewmU4dWP0ki8Q27A0VFiVRIpscvL" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/fontawesome.js" integrity="sha384-NY6PHjYLP2f+gL3uaVfqUZImmw71ArL9+Roi9o+I4+RBqArA2CfW1sJ1wkABFfPe" crossorigin="anonymous"></script>

	
	<!-- Custom Styles -->
	<style></style>
	

	
	<!-- Analytics Code -->
	
	

	
	<!-- Extra Header JS Code -->
	
	

	
	
</head>


<body class="loading ajax-loading" data-site-url="http://localhost:4000" data-page-url="/blog/kafka-internals5">


	<header class="header">

	<div class="header__content">

		
		<a href="/" class="header__title">
			Try
		</a>
		

		<h1 class="header__tagline">The man who moves a mountain begins by carrying away small stones. - Confucius</h1>

		<div class="menu">
			<div class="menu__toggle js-menu-toggle">
				<div class="menu__toggle__icon"><span></span></div>
			</div>
			<div class="menu__wrap">
				<ul class="menu__list">
					
					<li class="menu__list__item">
						<a href="/about" class="menu__list__item__link">About</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/apache" class="menu__list__item__link">Apache</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/blockchain" class="menu__list__item__link">BlockChain</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/computerscience" class="menu__list__item__link">Computer Science</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/database" class="menu__list__item__link">DataBase</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/devops" class="menu__list__item__link">DevOps</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/imageprocessing" class="menu__list__item__link">Image Processing</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/machinelearning" class="menu__list__item__link">Machine Learning</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/programming" class="menu__list__item__link">Programming</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/softwaremaestro" class="menu__list__item__link">SW Maestro</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/web" class="menu__list__item__link">Web</a>
					</li>
					
				</ul>
			</div>
		</div>

		<div class="projects-menu">
			<ul class="menu__list">
				
			</ul>
		</div>

		<div class="header__lower">

			<ul class="socials">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://github.com/has3ong" target="_blank" class="socials__item__link" title="Github">
			<i class="fab fa-github" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://www.linkedin.com/in/%ED%95%98%EC%84%B1-%EA%B9%80-145aa21a0/" target="_blank" class="socials__item__link" title="Linkedin">
			<i class="fab fa-linkedin" aria-hidden="true"></i>
		</a>
	</li>
	
	
</ul>

			<div class="footer__copyright">
				<span>© 2020 Try</span>
				Has3ong
			</div>

		</div>

	</div>

</header>


	<div class="loader"><svg width="120" height="30" viewBox="0 0 120 30" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="60" cy="15" r="9" fill-opacity="0.3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="0.5" to="0.5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle></svg></div>

	<div class="page-loader"></div>

	
	<div class="page">

		<div class="page__content" data-page-title="Apache Kafka Internals -5- – Try">

			<section class="intro">

	<div class="wrap">

		<h1>Apache Kafka Internals -5-</h1>
		<p>16 December 2019</p>

	</div>

</section>

<section class="single">

	<div class="wrap">

		<p><em>이 포스트는 <a href="https://github.com/Avkash/mldl/blob/master/pages/docs/books/confluent-kafka-definitive-guide-complete.pdf">Kafka Definitive Guide</a>를 바탕으로 작성하였습니다.</em></p>

<h2 id="compaction">Compaction</h2>

<p>Kafka 는 토픽 보존 정책을 사용하여 <strong>삭제 보존 정책</strong>, <strong>압축 보존 정책</strong> 을 모두 지원합니다. 삭제 보존 정책은 보존 기간 이전의 메세지를 삭제하며 압축 보존 정책은 각 키의 가장 최근 값만 토픽에 저장할 수 있습니다.</p>

<p>압축 보존 정책은 키와 값을 갖는 메세지를 생성하는 어플리케이션의 토픽에만, 적용되며, 토픽의 null 키가 포함되며 압축이 안됩니다.</p>

<h3 id="how-compaction-works">How Compaction Works</h3>

<p>키와 값의 형태로 된 메세지를 수록하는 각 로그 세그먼트는 아래 <code class="highlighter-rouge">Example 2</code> 와 같이 다음의 두 부분으로 나누어 생각할 수 있습니다.</p>

<ul>
  <li>Clean
    <ul>
      <li>이전에 압축되었던 메세지들이 있다.</li>
      <li>각 키에 대해 하나의 값만 포함하며, 이것은 이전에 압축할 당시의 가장 최근 값이다.</li>
    </ul>
  </li>
  <li>Dirty
    <ul>
      <li>직전 압축 이후에 추가로 쓴 메세지들이 저장되는 부분</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>Example 2 - Partition with clean and dirty portions</p>
</blockquote>

<p><img src="https://user-images.githubusercontent.com/44635266/70889678-8034a000-2026-11ea-994d-dbe779e9cd6a.png" alt="image" /></p>

<p>Kafka 가 시작될 때 압축이 활성화 되면 각 브로커는 하나의 압축 매니저 스레드와 여러 개의 압축 스레드를 시작시킨다. 이 스레드들은 압축 작업을 수행하는 책임을 가지며 각 스레드는 전체 파티션 크기보다 더티 메세지의 비율이 가장 큰 파티션을 선택하고 압축합니다.</p>

<p>파티션을 압축하기 위해 압축 스레드는 더티 메세지들을 읽어서 메모리에 압축용 오프셋 Map 을 생성합니다. 오프셋 Map 의 각 항목은 키(16byte hash value) 와 값(8byte) 로 구성되빈다. 따라서 각 항목은 24 byte 메모리만 사용됩니다.</p>

<p>예를들어, 각 세그먼트 크기는 1GB 이며 세그먼트의 각 메세지 크기는 1KB 라 가정한다면, 이 세그먼트는 100만 개의 메세지를 갖는다. 따라서 이 세그먼트를 압축하기 위해 필요한 오프셋 Map 은 24MB 면 됩니다. 그러나 실제로 이보다 적을 수 있습니다. 같은 키를 갖는 메세지들이 많아지면 메세지 키의 해시 값을 키로 사용하는 오프셋 Map의 항목 수도 적어질 것이기 때문입니다.</p>

<p>Kafka를 구성할 때 관리자는 오프셋 Map 에 사용할 메모리를 설정합니다. 이것은 각 압축 스레드가 따로 가질 수 있는 오프셋 Map의 크기를 합한 전체 메모리 입니다.</p>

<p>예를 들어, 오프셋 Map 을 1GB 로 구성하고 5개의 압축 스레드를 사용한다면, 각 스레드는 200MB 의 Map을 따로 가질 수 있습니다. 또한 파티션의 더티 부분 전체가 Map 에 다 들어가지 않아도 되지만, 최소한 하나의 세그먼트는 Map의 크기에 맞게 들어가야합니다. 그렇지 않으면 Kafka 가 에러를 발생시키므로, 관리자가 Map 의 메모리를 늘리거나 압축 스레드의 개수를 줄여서 사용해야합니다. 만약 소수의 세그먼트만 Map 에 들어간다면, Kafka 가 시작될 때 가장 오래된 세그먼트들부터 압축하여 Map 에 넣습니다. 그 외의 나머지 세그먼트들은 더티 부분에 남아있다가 다음 번 압축을 기다립니다.</p>

<p>압축 스레드가 오프셋 Map 을 생성한 다음에는 파티션의 클린 부분 세그먼트들을 가장 오래된 것부터 읽으면서 해당 세그먼트의 각 메세지 키가 오프셋 Map에 있는지 확인합니다. 만약 키가 오프셋 Map 에 없으면 방금 읽은 메세지의 값이 가장 최근 것이므로 해당 메세지를 대체 세그먼트로 복사합니다. 그렇지 않고 키가 오프셋 Map 에 있으면 해당 메세지는 제외합니다. 왜냐하면 같은 메세지 키를 가진 새로운 값이 파티션에 있기 떄문입니다. 그리고 세그먼트의 모든 처리가 끝나면 원래 세그먼트를 대체 세그먼트로 교체하고 다음 세그먼트를 계속 처리합니다. 모든 작업이 끝나면 같은 키를 가지는 메세지는 하나만 남게되고 가장 최근 값은 가지게 됩니다.<code class="highlighter-rouge">(Example 3)</code></p>

<blockquote>
  <p>Example 3 - Partition segment before and after compaction</p>
</blockquote>

<p><img src="https://user-images.githubusercontent.com/44635266/70890491-89bf0780-2028-11ea-81cf-7c6eb093487f.png" alt="image" /></p>

<h3 id="deleted-events">Deleted Events</h3>

<p>가장 최근 메세지조차 남기지 않고 시스템에 특정 키를 완전히 삭제할 때는 어플리케이션에서 해당 키와 null 값을 포함하는 메세지를 카프카에 쓰면 됩니다. 그러면 압축 스레드에서 그런 메세지를 발견할 때 평상시 대로 압축을 수행한 후 키에 대해서는 null 값을 갖는 메세지만 남겨둘 것입니다. 그리고 <strong>톰스톤(tombstone)</strong> 이라 하는 이런 특별한 메세지는 Kafka 에 설정된 기간 동안 보존될것이다.</p>

<p>또한, 이 기간 동안 컨슈머가 톰스톤 메세지를 읽으면 값이 null 이라 삭제되었음을 알 수 있으므로, 이와 관련된 데이터를 RDB 에 저장한다면 거기에서 해당 사용자를 삭제해야 한다는것도 알 수 있습니다. 그리고 Kafka 에 설정된 시간이 지나면 압축 스레드에서 톰스톤 메세지를 삭제할 것이고, 해당 키의 메세지는 파티션에서 없어질것입니다.</p>

<p>단, 이때 컨슈머가 톰스톤 메세지를 인식하기에 충분한 시간을 주어야 합니다. 왜냐하면 만에 하나 컨슈머가 여러시간 동안 중단되어 톰스톤 메세지가 누락된다면 해당 키를 알지 못할것이고, 이로 인해 Kafka 에서 삭제된것인지 또는 컨슈머의 DB 에서 삭제해야 하는지 알 수 없기 때문입니다.</p>

<h3 id="when-are-topics-compacted">When Are Topics Compacted?</h3>

<p>Kafka 에서는 현재 사용 중인 세그먼트가 아닌 사용 중이 아닌 세그먼트의 메세지들만 압축 대상이 됩니다.</p>


	</div>



</section>
			
				<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://has3ong-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			

		</div>

	</div>

	<footer class="footer">

	<ul class="socials">
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://github.com/has3ong" target="_blank" class="socials__item__link" title="Github">
			<i class="fab fa-github" aria-hidden="true"></i>
		</a>
	</li>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<li class="socials__item">
		<a href="https://www.linkedin.com/in/%ED%95%98%EC%84%B1-%EA%B9%80-145aa21a0/" target="_blank" class="socials__item__link" title="Linkedin">
			<i class="fab fa-linkedin" aria-hidden="true"></i>
		</a>
	</li>
	
	
</ul>

	<div class="footer__copyright">
		<span>© 2020 Try</span>
		Has3ong
	</div>

</footer>


	<!-- Javascript Assets -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="/js/index-min.js"></script>

	
	<!-- Extra Footer JS Code -->
	
	


</body>

</html>